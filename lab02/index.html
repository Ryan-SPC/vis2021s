<!DOCTYPE html>

<html>
	<head>
		<script src="https://d3js.org/d3.v3.min.js"></script>
		
		<style>
      		@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@900&display=swap');

		    div, ul {
		      border: solid black 1px;
		      margin: 5px;
		      padding: 10px;
		      background-color: rgba(255, 255, 128, 0.1);
		    }

		    div:hover, ul:hover {
		      background-color: rgba(255, 128, 128, 0.1);
		    }

			html, body {
				height: 100%;
				width: 100%;
				padding: 0;
				margin: 0;
				padding: 10px;
		        background-color: rgba(255, 255, 0, 0.02);
			}

			svg {
		        font-family: 'Noto Serif JP', serif;
			}

			#dropfile {
				height: 5%;
				width: 100%;
				border-style: dotted;;
				display: block;
				text-align: center;
			    animation-name: oxxo;
			    animation-duration: 2s;
			    animation-iteration-count: infinite;
			    padding: 10px;
		        background-color: rgba(255, 255, 0, 0.1);
		        font-family: 'Noto Serif JP', serif;
		        margin-bottom: 10px;
			}
			#dropfile:hover {
			    background-color: rgba(128, 255, 255, 0.1);
			}
			@keyframes oxxo{
			    from {
			        border-style: dotted;;
			        border-color: blue;
			        color: blue;
			    }
			    to {
			        border-style: solid;
			        border-color: red;
			        color: crimson;
			    }
			}
			
			#treemap {
				height: 95%;
				width: 100%;
			}
		</style>
	</head>
	<body>
		<div>
			Lab 02 treemap
		</div>
		<ul>
			<li>遠距教學授課防疫演練: 2021.03.18 (四) </li>
			<li>上台報告: 2021.04.01 (四) </li>
			<li><a href="https://www.d3-graph-gallery.com/graph/treemap_custom.html">Treemap customization in d3.js</a></li>
			<li><a href="http://blog.infographics.tw/2015/10/d3js-tutorial-treemap-and-budget/">D3.js 實戰 － 利用 Treemap Layout 將政府預算視覺化</a></li>
		</ul>

		<div id="dropfile" for="csvfile">
			CSV 資料扔過來! Drop your CSV here.
		</div>
		
		<div class="demo">
			<li>台中月平均降雨量</li>
		</div>
		
		
		<script>
			dataPath = './';
dataFile = 'd3demoData141011.csv';
dataUrl = dataPath + dataFile;
//定義SVG的大小
d3.csv(dataUrl, function(data){
	console.debug(JSON.stringify(data));
	dataset = data;

	var w = 600,h = 250,padding = 30, barMargin = 2;
	//定義寬高,padding等等值

	// var Ymax = d3.max(dataset, function(d){return d.value}),
	// 	Ymin = d3.min(dataset, function(d){return d.value});
	var Ymax = 350,
		Ymin = 0;
		//取得Y軸的最大值

	var xScale = d3.scale.linear() //產生一個屬於X軸的線性尺度
		.domain([0, dataset.length]) //傳入的值是原始資料的最小及最大值
		.range([padding , w - padding]) 
		//輸出的範圍是左邊的padd距離，到右邊的padding

	var yScale = d3.scale.linear()
		.domain([Ymin, Ymax])
		.range([padding, h - padding])
		//類似X軸的尺度
	var yScale = d3.scale.linear()
		.domain([Ymin, Ymax])
		.range([padding, h - padding])
		//類似X軸的尺度

	var colorScale = d3.scale.linear()
		.domain([Ymin, Ymax])
		.range([0, 700])
		//這次顏色都要用尺度來算

	var barWidth = (w - padding*2) / dataset.length - barMargin;

	var svg = d3.select('.demo').append('svg').attr({'width': w,'height': h})
		//接下來開始產生SVG
		
	svg.selectAll('rect').data(dataset).enter() //和先前一樣，選取'circle'並把資料加入
	.append('rect') // 增加圓到SVG內
	.attr({	//加入屬性到圓
		'x': function(d, i){return xScale(i)}, //利用尺度算出X的位置
		'y': function(d){return h - yScale(d.value)}, //同理算出Y
		'width': barWidth,
		'height':function(d){return yScale(d.value)}, //同理算出Y
		// 'r': function(d){return Math.sqrt(h - d[1])}, //圓的大小是高 - Y值的平方
		'fill': function(d){
			var color = 0.2 + colorScale(d.value) * 0.001;
			return  d3.hsl(200 ,color, color); //利用尺度來算出顏色
		},
		'title': function(d){
			return 'Name : ' + d.name;
		}
		//介紹一個顏色的function hsl，可以將顏色算出後轉成色碼
		//格式 (360色相, 1彩度, 1明度)
	});

	svg.selectAll('text').data(dataset).enter() //補上資料數值
	.append('text') 
	.text(function(d){ return d.value}) //將值寫到SVG上
	.attr({
		'x': function(d, i){return xScale(i) + barWidth/2}, //和上面相同，算出X、Y的位置
		'y': function(d){return h - yScale(d.value) + 15},
		'fill': 'white', //文字填滿為紅色
		'text-anchor': 'middle',
		'font-size': '10px' //Fill、font-size也可以用CSS寫喔～
	});

	svg.append('g').selectAll('text').data(dataset).enter() //這邊再多做一個人名顯示的區域
	.append('text') 
	.text(function(d){ return d.name}) //寫入人名
	.attr({
		'x': function(d, i){return xScale(i) + barWidth/2}, //和上面相同，算出X、Y的位置
		'y': function(d){return h - yScale(d.value) - 10},
		'fill': 'SlateGray', //文字填滿為超漂亮灰色
		'text-anchor': 'middle',
		'font-size': '10px' //Fill、font-size也可以用CSS寫喔～
	});

});
		</script>
		
		<script>
			window.addEventListener('load', () => {
				const treemapContainer = document.getElementById('treemap')
				
				document.getElementById('dropfile').addEventListener('dragover', (evt) => {
					evt.preventDefault()
				})
				
				document.getElementById('dropfile').addEventListener('drop', (evt) => {
					evt.preventDefault()
					
					const { files } = evt.dataTransfer
					
					if(files.length){
						if(treemapContainer.innerHTML.length){
							treemapContainer.innerHTML = ''
						}
					
						const csvFile = files[0]
						
						//讀取csv
						const fr = new FileReader()
						
						fr.onload = () => {
							const allBoss = []
							const studentArr = fr.result.split('\n').map(e => e.split(','))
							
							const d3Json = {
								children: [],
								name: 'vis2021s'
							}
							
							//先由小到大排列，算出名次、級距、再算出分數
							const mapping = new Array(41).fill(-1)
							const scoreSort = studentArr.sort((x,y) => {
								let a = isNaN(parseFloat(x[3])) ? 40 : parseFloat(x[3])
								let b = isNaN(parseFloat(y[3])) ? 40 : parseFloat(y[3])
								
								return a-b
							}).map(e => isNaN(parseFloat(e[3])) ? 40 : parseFloat(e[3]))
							
							const scoreSet = [...new Set([...scoreSort.filter(e => e<=30)])]
							const step = (100 - 60) / scoreSet.length
							
							for(let i of scoreSort){
								const idx = scoreSet.indexOf(i)
								let score
								if(idx == -1){
									score = 50
								}
								else{
									score = (100 - step * idx).toFixed(2)
								}
								mapping[i] = score
							}
							
							
							
							
							for(let i of studentArr){
								const bossName = i[2].length ? i[2] : (i[1] == '碩' ? '未知' : '資工四')
								
								
								if(allBoss.indexOf(bossName) == -1){
									allBoss.push(bossName)
									d3Json.children.push({
										name: bossName,
										children: []
									})
								}
								
								const seconds = isNaN(parseInt(i[3])) ? 40 : parseInt(i[3])
								
								d3Json.children.find(e => e.name == bossName).children.push({
									name: i[0],
									seconds,
									value: parseFloat(mapping[seconds])
								})
								

								
							}
							treemapContainer.appendChild(mkSVG(treemapContainer, allBoss, d3Json))
							
						}
						
						fr.readAsText(csvFile)
					}
					
				})

				
			
			})
			
		</script>
	
	</body>
	
</html>